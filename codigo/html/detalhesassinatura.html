<!DOCTYPE html>
<html lang="pt-br">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
    <link rel="stylesheet" href="../assets/css/conf.css">
    <link rel="shortcut icon" href="../assets/img/logo (1).png" type="image/x-icon">
    <link rel="stylesheet" type="text/css" media="screen"
        href="https://maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css" />
    <title>Assinatura - DataStock</title>
</head>

<body>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz"
        crossorigin="anonymous"></script>

    <!-- Inicio Cabeçalho -->
    <header>
        <nav class="navbar navbar-expand-lg bg-body-tertiary fixed-top">
            <!-- Logo DataStock -->
            <div class="container-fluid">
                <a class="navbar-brand" href="../html/telaempres.html">
                    <img src="../assets/img/logo.png" alt="DataStock" width="70" height="50">
                </a>
                <button class="navbar-toggler" type="button" data-bs-toggle="collapse"
                    data-bs-target="#navbarNavAltMarkup" aria-controls="navbarNavAltMarkup" aria-expanded="false"
                    aria-label="Toggle navigation">
                    <span class="navbar-toggler-icon"></span>
                </button>
            </div>
            <!-- Fim logo Data Stock -->
            <!-- Opções a Direita do NAV -->
            <div class="collapse navbar-collapse m-2" id="navbarNavAltMarkup">
                <div class="navbar-nav">
                    <a class="nav-link" href="../html/telaempres.html">Inicio</a>
                    <a class="nav-link" href="conf.html">Configuração</a>
                    <a class="nav-link" href="#contatos">Contato/Dúvidas</a>
                </div>
            </div>
            <!-- Fim Opções e NAV -->
        </nav>
    </header>
    <main>
        <div class="container_conta">
            <header class="header">
                <h1 style="font-size: larger;">Detalhes da assinatura</h1>
                <p>Detalhes da assinatura</p>
            </header>
            <div class="card w-75 mb-3">
                <div class="card-header">
                </div>
                <div class="card-body">
                    <h1 class="card-title text-primary">Detalhes da assinatura: </h1>
                    <span><strong>Nome do plano:</strong></span>
                    <span id="nomeplano"></span><br>
                    <br>
                    <span><strong>Tipo de Contratação:</strong></span>
                    <span id="contrat"></span><br>
                    <br>
                    <span><strong>Data do último pagamento:</strong></span>
                    <span id="pag"></span><br>
                    <br>
                    <span><strong>Data do próximo pagamento:</strong></span>
                    <span id="prox"></span><br>
                    <br>
                </div>
            </div>
        </div>
        <div class="container_conta">
            <div class="card w-75 mb-3">
                <div class="card-header">
                </div>
                <div class="card-body">
                    <h1 class="card-title text-primary">Detalhes do pagamento: </h1>
                    <span><strong>Tipo do cartão:</strong></span>
                    <span id="tipocart"></span>
                    <br> <br>
                    <span><strong>Nome do Cartão:</strong></span>
                    <span id="nomecard"></span>
                    <br> <br>
                    <span><strong>Número do Cartão:</strong></span>
                    <span id="numcard"></span>
                    <br><br>
                    <span><strong>Nome do Comprador:</strong></span>
                    <span id="nomecomp"></span>
                    <br><br>
                    <span><strong>Valor do pagamento:</strong></span>
                    <span id="valorpag"></span>
                    <br><br>
                    <span>*Esses dados são apenas para parâmetro, para a sua segurança, os dados do pagamento do plano
                        não serão mostrados aqui, para mostrar os cartões, adicione o cartão na seção abaixo</span>
                </div>
            </div>
            <div class="card w-75 mb-3">
                <div class="card-header">
                </div>
                <div class="card-body">
                    <h1 class="card-title text-primary">Cartões Cadastrados</h1>
                    <!-- Button trigger modal -->
                    <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#exampleModal">
                        Adicionar Cartão
                    </button>

                    <!-- Modal -->
                    <div class="modal fade" id="exampleModal" tabindex="-1" aria-labelledby="exampleModalLabel"
                        aria-hidden="true">
                        <div class="modal-dialog">
                            <div class="modal-content">
                                <div class="modal-header">
                                    <h1 class="modal-title fs-5" id="exampleModalLabel">Adicionar Cartão</h1>
                                    <button type="button" class="btn-close" data-bs-dismiss="modal"
                                        aria-label="Close"></button>
                                </div>
                                <div class="modal-body">
                                    <form id="cartaoForm">
                                        <div class="mb-3">
                                            <label for="nocart" class="form-label">Nome do Cartão:</label>
                                            <input type="text" class="form-control" id="nocart" name="nocart" required>
                                        </div>
                                        <div class="mb-3">
                                            <label for="valid" class="form-label">Validade (MM/AA):</label>
                                            <input type="text" class="form-control" id="valid" name="valid" required
                                                pattern="\d{2}/\d{2}" title="Formato esperado: MM/AA">

                                        </div>
                                        <div class="mb-3">
                                            <label for="cvvv" class="form-label">CVV:</label>
                                            <input type="text" class="form-control" id="cvvv" name="cvvv" required>
                                        </div>
                                        <div class="mb-3">
                                            <label for="nomecomple" class="form-label">Nome Completo:</label>
                                            <input type="text" class="form-control" id="nomecomple" name="nomecomple"
                                                required>
                                        </div>
                                        <div class="mb-3">
                                            <label for="numerocart" class="form-label">Número do Cartão:</label>
                                            <input type="text" class="form-control" id="numerocart" name="numerocart"
                                                required minlength="19" maxlength="19"
                                                pattern="\d{4}\s\d{4}\s\d{4}\s\d{4}"
                                                title="Formato esperado: 1234 5678 9012 3456">
                                        </div>
                                        <div class="mb-3">
                                            <label for="tipodocartao" class="form-label">Tipo do Cartão:</label>
                                            <select class="form-select" id="tipodocartao" name="tipodocartao" required>
                                                <option value="Crédito">Crédito</option>
                                                <option value="Débito">Débito</option>
                                            </select>
                                        </div>
                                    </form>
                                </div>
                                <div class="modal-footer">
                                    <button type="button" class="btn btn-secondary"
                                        data-bs-dismiss="modal">Cancelar</button>
                                    <button type="button" class="btn btn-primary" onclick="adicionarCartao()">Adicionar
                                        Cartão</button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <table class="table table-striped mt-4" id="cartoesTable">
                        <thead>
                            <tr>
                                <th>Nome do Cartão</th>
                                <th>Validade</th>
                                <th>CVV</th>
                                <th>Nome Completo</th>
                                <th>Número do Cartão</th>
                                <th>Tipo do Cartão</th>
                                <th>Ações</th>
                            </tr>
                        </thead>
                        <tbody>
                            <!-- Linhas de cartões serão adicionadas aqui -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Toasts -->
        <div class="toast-container position-fixed bottom-0 end-0 p-3">
            <div id="toastSucesso" class="toast" role="alert" aria-live="assertive" aria-atomic="true">
                <div class="toast-header">
                    <strong class="me-auto">Sucesso</strong>
                    <button type="button" class="btn-close" data-bs-dismiss="toast" aria-label="Close"></button>
                </div>
                <div class="toast-body">
                    Cartão adicionado com sucesso!
                </div>
            </div>
            <div id="toastErro" class="toast" role="alert" aria-live="assertive" aria-atomic="true">
                <div class="toast-header">
                    <strong class="me-auto">Erro</strong>
                    <button type="button" class="btn-close" data-bs-dismiss="toast" aria-label="Close"></button>
                </div>
                <div class="toast-body">
                    Por favor, preencha todos os campos corretamente.
                </div>
            </div>
        </div>

        <script>
            document.addEventListener('DOMContentLoaded', function () {
                renderizarCartoes();
            });
        
            function adicionarCartao() {
                const nocart = document.getElementById('nocart').value;
                const valid = document.getElementById('valid').value;
                const cvvv = document.getElementById('cvvv').value;
                const nomecomple = document.getElementById('nomecomple').value;
                const numerocart = formatarNumeroCartao(document.getElementById('numerocart').value);
                const tipodocartao = document.getElementById('tipodocartao').value;
        
                if (nocart.length >= 10 && cvvv.length ==3 && valid.length ==5 && numerocart.length == 19) {
                    const pagamentoinfo3 = {
                        "nocart": nocart,
                        "valid": valid,
                        "cvvv": cvvv,
                        "nomecomple": nomecomple,
                        "numcard": numerocart,
                        "tipodocartao": tipodocartao
                    };
        
                    fetch('http://localhost:3000/cartoes', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(pagamentoinfo3)
                    })
                        .then(response => response.json())
                        .then(data => {
                            // Renderiza os cartões novamente após adicionar
                            renderizarCartoes();
                            // Limpa o formulário após adicionar
                            document.getElementById('cartaoForm').reset();
                            // Mostra o toast de sucesso
                            mostrarToast('toastSucesso');
                        })
                        .catch(error => {
                            console.error('Erro ao adicionar cartão:', error);
                            mostrarToast('toastErro');
                        });
                } else {
                    mostrarToast('toastErro');
                }
            }
        
            function editarCartao(id) {
                fetch(`http://localhost:3000/cartoes/${id}`)
                    .then(response => response.json())
                    .then(cartao => {
                        // Preenche o formulário com os dados do cartão
                        document.getElementById('nocart').value = cartao.nocart;
                        document.getElementById('valid').value = cartao.valid;
                        document.getElementById('cvvv').value = cartao.cvvv;
                        document.getElementById('nomecomple').value = cartao.nomecomple;
                        document.getElementById('numerocart').value = cartao.numcard;
                        document.getElementById('tipodocartao').value = cartao.tipodocartao;
        
                        // Altera a função do botão "Adicionar" para "Salvar Alterações"
                        const modalFooter = document.querySelector('#exampleModal .modal-footer');
                        modalFooter.innerHTML = `
                            <button type="button" class="btn btn-success" onclick="salvarAlteracoes('${cartao.id}')">Salvar Alterações</button>
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                        `;
                    })
                    .catch(error => {
                        console.error('Erro ao editar cartão:', error);
                    });
            }
        
            function salvarAlteracoes(id) {
                const nocart = document.getElementById('nocart').value;
                const valid = document.getElementById('valid').value;
                const cvvv = document.getElementById('cvvv').value;
                const nomecomple = document.getElementById('nomecomple').value;
                const numerocart = formatarNumeroCartao(document.getElementById('numerocart').value);
                const tipodocartao = document.getElementById('tipodocartao').value;
        
                if (nocart.length >= 10 && valid.length == 5 && cvvv.length == 3 && nomecomple.length >= 10 && numerocart.length == 19) {
                    const dadosAtualizados = {
                        "nocart": nocart,
                        "valid": valid,
                        "cvvv": cvvv,
                        "nomecomple": nomecomple,
                        "numcard": numerocart,
                        "tipodocartao": tipodocartao
                    };
        
                    fetch(`http://localhost:3000/cartoes/${id}`, {
                        method: 'PUT',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(dadosAtualizados)
                    })
                        .then(response => response.json())
                        .then(data => {
                            // Renderiza os cartões novamente após editar
                            renderizarCartoes();
                            // Limpa o formulário após adicionar
                            document.getElementById('cartaoForm').reset();
                            // Fecha o modal de edição
                            const modal = document.getElementById('exampleModal');
                            const bootstrapModal = bootstrap.Modal.getInstance(modal);
                            bootstrapModal.hide();
                            // Mostra o toast de sucesso
                            mostrarToast('toastSucesso');
                        })
                        .catch(error => {
                            console.error('Erro ao salvar alterações:', error);
                            mostrarToast('toastErro');
                        });
                } else {
                    mostrarToast('toastErro');
                }
            }
        
            function renderizarCartoes() {
                const cartoesTable = document.getElementById('cartoesTable').getElementsByTagName('tbody')[0];
                cartoesTable.innerHTML = '';
        
                fetch('http://localhost:3000/cartoes')
                    .then(response => response.json())
                    .then(cartoes => {
                        cartoes.forEach((cartao, index) => {
                            const newRow = cartoesTable.insertRow();
        
                            // Adiciona cada valor do cartão em uma célula da nova linha
                            Object.entries(cartao).forEach(([key, val]) => {
                                // Verifica se a chave não é 'id' antes de adicionar à tabela
                                if (key !== 'id') {
                                    const newCell = newRow.insertCell();
                                    const newText = document.createTextNode(val);
                                    newCell.appendChild(newText);
                                }
                            });
        
                            // Cria as ações (editar e excluir) para cada cartão
                            const actionsCell = newRow.insertCell();
                            actionsCell.innerHTML = `
                                <button class="btn btn-primary" onclick="editarCartao('${cartao.id}')" data-bs-toggle="modal" data-bs-target="#exampleModal">Editar</button>
                                <button class="btn btn-danger" onclick="excluirCartao('${cartao.id}')">Excluir</button>
                            `;
                        });
                    })
                    .catch(error => {
                        console.error('Erro ao renderizar cartões:', error);
                    });
            }
        
            function excluirCartao(id) {
                fetch(`http://localhost:3000/cartoes/${id}`, {
                    method: 'DELETE'
                })
                    .then(() => {
                        // Renderiza os cartões novamente após excluir
                        renderizarCartoes();
                        // Mostra o toast de sucesso
                        mostrarToast('toastSucesso');
                    })
                    .catch(error => {
                        console.error('Erro ao excluir cartão:', error);
                        mostrarToast('toastErro');
                    });
            }
        
            function mostrarToast(toastId) {
                const toastElement = document.getElementById(toastId);
                const toast = new bootstrap.Toast(toastElement);
                toast.show();
            }
        
            // Função para formatar o número do cartão
            function formatarNumeroCartao(numero) {
                // Remove espaços em branco e formata com espaços a cada 4 dígitos
                return numero.replace(/\s/g, '').replace(/(\d{4})(?=\d)/g, '$1 ');
            }
        
            // Adiciona um listener para o evento 'input' no campo de número do cartão
            document.getElementById('numerocart').addEventListener('input', function (e) {
                let valorAtual = e.target.value;
        
                // Remove todos os caracteres não numéricos do valor atual
                valorAtual = valorAtual.replace(/\D/g, '');
        
                // Limita a 16 caracteres
                if (valorAtual.length > 16) {
                    valorAtual = valorAtual.slice(0, 16);
                }
        
                // Formata o valor e atualiza o campo
                e.target.value = formatarNumeroCartao(valorAtual);
            });
        
            // Função para formatar o campo de validade (MM/AA)
            function formatarValidade(valor) {
                // Remove todos os caracteres não numéricos do valor atual
                valor = valor.replace(/\D/g, '');
        
                // Limita a 4 caracteres (dois dígitos para mês e dois para ano)
                if (valor.length > 4) {
                    valor = valor.slice(0, 4);
                }
        
                // Insere o '/' automaticamente após os dois primeiros dígitos (mês)
                if (valor.length > 2) {
                    valor = valor.replace(/(\d{2})(\d{2})/, '$1/$2');
                }
        
                return valor;
            }

        
            // Adiciona um listener para o evento 'input' no campo de validade
            document.getElementById('valid').addEventListener('input', function (e) {
                let valorAtual = e.target.value;
                e.target.value = formatarValidade(valorAtual);
            });

            document.addEventListener('DOMContentLoaded', function () {
                const pagamentoinfo = JSON.parse(localStorage.getItem('usuarioLogado'));
                const planocomprado = JSON.parse(localStorage.getItem('usuarioLogado'));
     
                document.getElementById('nomeplano').innerHTML = planocomprado.titulo;
                document.getElementById('contrat').innerHTML = pagamentoinfo.tipoplano;
                document.getElementById('prox').innerHTML = pagamentoinfo.dataproxpagamento;
                document.getElementById('pag').innerHTML = pagamentoinfo.datapagamento;
                document.getElementById('tipocart').innerHTML = pagamentoinfo.formadepagamento;
                document.getElementById('nomecard').innerHTML = pagamentoinfo.nocart;
                document.getElementById('numcard').innerHTML = cartaooculto(pagamentoinfo.numcard);
                document.getElementById('nomecomp').innerHTML = pagamentoinfo.nomecomple;
                document.getElementById('valorpag').innerHTML = planocomprado.valor;
            });

            function cartaooculto(numCartao) {
                const numcartfor = numCartao.slice(-4); 
                return `************${numcartfor}`; 
            }

        
        </script>
    </main>
    <footer class='container-fluid bg-primary p-3 mt-3'
    style="display: flex; justify-content: center; flex-direction: column; align-items: center;">
    <img src='../assets/img/logo.png' style='width: 150px; margin: 30px; background-color: white; padding: 10px; border-radius: 10px; box-shadow: 3px 3px 5px 5px rgba(0, 0, 0, 0.147);'/>
          <h2 class="text-white p-2" style="font-size: 50px;">DataStock</h2>
          <p class="text-white">&copy; 2024 - Todos os direitos reservados</p>
          <div><span><a href="./fale-conosco.html" style="color: white;" class="ms-3">Fale conosco</a></span>
            <span><a href="./Planos.html" style="color: white;" class="ms-3">Planos</a></span>
            <span><a href="https://www.reclameaqui.com.br" style="color: white;" class="ms-3">Reclame Aqui</a></span>
            <span><a href="./sobrenos.html" style="color: white;" class="ms-3">Sobre nós</a></span></div>
          
  </footer>
</body>

</html>